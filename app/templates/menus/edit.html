{% extends "base.html" %}

{% block title %}Modifier {{ menu.nom }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/recipe-search.css') }}">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('menus.index') }}">Menus</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('menus.detail', id=menu.id) }}">{{ menu.nom }}</a></li>
                <li class="breadcrumb-item active">Modifier</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-10 offset-lg-1">
        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="card-title mb-4">
                    <i class="bi bi-pencil"></i> Modifier le menu
                </h1>

                <form method="POST" action="{{ url_for('menus.edit', id=menu.id) }}">
                    <!-- Informations générales -->
                    <h4 class="mb-3">Informations générales</h4>

                    <div class="mb-3">
                        <label for="nom" class="form-label">Nom du menu *</label>
                        <input type="text" class="form-control" id="nom" name="nom" value="{{ menu.nom }}" required>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="date_debut" class="form-label">Date de début *</label>
                            <input type="date" class="form-control" id="date_debut" name="date_debut" value="{{ menu.date_debut.strftime('%Y-%m-%d') }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="nb_personnes" class="form-label">Nombre de personnes *</label>
                            <input type="number" class="form-control" id="nb_personnes" name="nb_personnes" value="{{ menu.nb_personnes }}" min="1" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="theme" class="form-label">Thème</label>
                        <input type="text" class="form-control" id="theme" name="theme" value="{{ menu.theme or '' }}">
                    </div>

                    <div class="mb-4">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ menu.description or '' }}</textarea>
                    </div>

                    <hr>

                    <!-- Planning de la semaine -->
                    <h4 class="mb-3">Planning de la semaine</h4>
                    <p class="text-muted">Modifiez les recettes pour chaque repas. Les quantités seront automatiquement ajustées selon le nombre de personnes.</p>

                    {% set jours_noms = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'] %}
                    {% for i in range(7) %}
                    {% set jour = menu.jours|selectattr('jour_semaine', 'equalto', i)|first %}
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">{{ jours_noms[i] }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <label for="search_jour_{{ i }}_petit_dejeuner" class="form-label">
                                        <i class="bi bi-sunrise"></i> Petit-déjeuner
                                    </label>
                                    <input type="text"
                                           class="form-control recipe-search-input"
                                           id="search_jour_{{ i }}_petit_dejeuner"
                                           placeholder="Rechercher...">
                                    <input type="hidden"
                                           id="jour_{{ i }}_petit_dejeuner"
                                           name="jour_{{ i }}_petit_dejeuner"
                                           value="{{ jour.petit_dejeuner_id if jour and jour.petit_dejeuner_id else '' }}">
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label for="search_jour_{{ i }}_dejeuner" class="form-label">
                                        <i class="bi bi-sun"></i> Déjeuner
                                    </label>
                                    <input type="text"
                                           class="form-control recipe-search-input"
                                           id="search_jour_{{ i }}_dejeuner"
                                           placeholder="Rechercher...">
                                    <input type="hidden"
                                           id="jour_{{ i }}_dejeuner"
                                           name="jour_{{ i }}_dejeuner"
                                           value="{{ jour.dejeuner_id if jour and jour.dejeuner_id else '' }}">
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label for="search_jour_{{ i }}_gouter" class="form-label">
                                        <i class="bi bi-cup-straw"></i> Goûter
                                    </label>
                                    <input type="text"
                                           class="form-control recipe-search-input"
                                           id="search_jour_{{ i }}_gouter"
                                           placeholder="Rechercher...">
                                    <input type="hidden"
                                           id="jour_{{ i }}_gouter"
                                           name="jour_{{ i }}_gouter"
                                           value="{{ jour.gouter_id if jour and jour.gouter_id else '' }}">
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label for="search_jour_{{ i }}_diner" class="form-label">
                                        <i class="bi bi-moon-stars"></i> Dîner
                                    </label>
                                    <input type="text"
                                           class="form-control recipe-search-input"
                                           id="search_jour_{{ i }}_diner"
                                           placeholder="Rechercher...">
                                    <input type="hidden"
                                           id="jour_{{ i }}_diner"
                                           name="jour_{{ i }}_diner"
                                           value="{{ jour.diner_id if jour and jour.diner_id else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <hr>

                    <!-- Boutons -->
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{{ url_for('menus.detail', id=menu.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Enregistrer les modifications
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/recipe-search.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les composants de recherche pour chaque jour et repas
    const repasTypes = {
        'petit_dejeuner': 'petit_dejeuner',
        'dejeuner': 'dejeuner',
        'gouter': 'gouter',
        'diner': 'diner'
    };

    for (let jour = 0; jour < 7; jour++) {
        for (const [repasKey, repasType] of Object.entries(repasTypes)) {
            const searchInputId = `search_jour_${jour}_${repasKey}`;
            const hiddenInputId = `jour_${jour}_${repasKey}`;
            const hiddenInput = document.getElementById(hiddenInputId);

            const searchInstance = new RecipeSearch(searchInputId, hiddenInputId, {
                menuId: {{ menu.id }},
                typeRepas: repasType,
                currentRecipeId: hiddenInput && hiddenInput.value ? parseInt(hiddenInput.value) : null,
                placeholder: 'Rechercher une recette ou un ingrédient...'
            });

            // Stocker l'instance globalement
            window.recipeSearchInstances[searchInputId] = searchInstance;
        }
    }
});
</script>
{% endblock %}
