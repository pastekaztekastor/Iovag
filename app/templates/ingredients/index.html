{% extends "base.html" %}

{% block title %}Base d'ingrédients{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-5">
            <i class="bi bi-egg"></i> Base d'ingrédients
        </h1>
        <p class="lead text-muted">{{ ingredients|length }} ingrédient(s)</p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('ingredients.create') }}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle"></i> Nouvel ingrédient
        </a>
    </div>
</div>

<!-- Filtres -->
<div class="row mb-4">
    <div class="col-md-3">
        <input type="text" class="form-control" id="searchIngredients" placeholder="Rechercher un ingrédient...">
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterCategorie">
            <option value="">Toutes les catégories</option>
            {% for categorie in categories %}
            <option value="{{ categorie }}">{{ categorie }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterRangement">
            <option value="">Tous les rangements</option>
            {% for lieu in lieux_rangement %}
            <option value="{{ lieu }}">{{ lieu }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterSaison">
            <option value="">Toutes saisons</option>
            <option value="current">De saison (mois actuel)</option>
            {% for mois in mois_list %}
            <option value="{{ mois }}">{{ mois }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Liste des ingrédients -->
{% if ingredients %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Catégorie</th>
                <th>Rangement</th>
                <th>Unité</th>
                <th>Conservation</th>
                <th>Stock limite</th>
                <th>Saison</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="ingredientsTableBody">
            {% for ingredient in ingredients %}
            <tr class="ingredient-row"
                data-nom="{{ ingredient.nom|lower }}"
                data-categorie="{{ ingredient.categorie or '' }}"
                data-rangement="{{ ingredient.lieu_rangement or '' }}"
                data-saison="{{ ingredient.mois_saison or '' }}">
                <td><strong>{{ ingredient.nom }}</strong></td>
                <td>
                    {% if ingredient.categorie %}
                    <span class="badge bg-info">{{ ingredient.categorie }}</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if ingredient.lieu_rangement %}
                    <span class="badge bg-secondary">
                        <i class="bi bi-geo-alt"></i> {{ ingredient.lieu_rangement }}
                    </span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>{{ ingredient.unite_mesure or '-' }}</td>
                <td>
                    {% if ingredient.duree_conservation %}
                    {{ ingredient.duree_conservation }}j
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if ingredient.stock_limite %}
                    <span class="badge bg-warning text-dark">
                        <i class="bi bi-exclamation-triangle"></i> {{ ingredient.stock_limite }} {{ ingredient.unite_mesure or '' }}
                    </span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if ingredient.mois_saison %}
                    {% set mois_liste = ingredient.get_mois_saison_list() %}
                    {% if mois_liste|length <= 3 %}
                        <small class="text-success">
                            <i class="bi bi-calendar3"></i> {{ mois_liste|join(', ') }}
                        </small>
                    {% else %}
                        <small class="text-success" title="{{ mois_liste|join(', ') }}">
                            <i class="bi bi-calendar3"></i> {{ mois_liste|length }} mois
                        </small>
                    {% endif %}
                    {% else %}
                    <span class="text-muted" title="Toute l'année">
                        <i class="bi bi-calendar-check"></i> Toute l'année
                    </span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('ingredients.edit', id=ingredient.id) }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <form method="POST" action="{{ url_for('ingredients.delete', id=ingredient.id) }}" class="d-inline" onsubmit="return confirmDelete('Êtes-vous sûr de vouloir supprimer cet ingrédient ?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> Aucun ingrédient dans la base.
    <a href="{{ url_for('ingredients.create') }}" class="alert-link">Ajouter le premier</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Obtenir le mois actuel
const currentMonth = new Date().toLocaleString('fr-FR', { month: 'long' });
const currentMonthCapitalized = currentMonth.charAt(0).toUpperCase() + currentMonth.slice(1);

// Fonction de filtrage des ingrédients
function filterIngredients() {
    const searchValue = document.getElementById('searchIngredients').value.toLowerCase();
    const categorieValue = document.getElementById('filterCategorie').value;
    const rangementValue = document.getElementById('filterRangement').value;
    const saisonValue = document.getElementById('filterSaison').value;

    const rows = document.querySelectorAll('.ingredient-row');
    let visibleCount = 0;

    rows.forEach(row => {
        const nom = row.getAttribute('data-nom');
        const categorie = row.getAttribute('data-categorie');
        const rangement = row.getAttribute('data-rangement');
        const saison = row.getAttribute('data-saison');

        // Vérifier chaque critère
        const matchSearch = nom.includes(searchValue);
        const matchCategorie = !categorieValue || categorie === categorieValue;
        const matchRangement = !rangementValue || rangement === rangementValue;

        // Vérifier la saison
        let matchSaison = true;
        if (saisonValue) {
            if (saisonValue === 'current') {
                // Filtrer par mois actuel
                if (saison) {
                    matchSaison = saison.includes(currentMonthCapitalized);
                } else {
                    // Si pas de saison définie, disponible toute l'année
                    matchSaison = true;
                }
            } else {
                // Filtrer par un mois spécifique
                if (saison) {
                    matchSaison = saison.includes(saisonValue);
                } else {
                    // Si pas de saison définie, disponible toute l'année
                    matchSaison = true;
                }
            }
        }

        // Afficher la ligne si tous les critères correspondent
        if (matchSearch && matchCategorie && matchRangement && matchSaison) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Mettre à jour le compteur
    const countElement = document.querySelector('.lead.text-muted');
    if (countElement) {
        const total = rows.length;
        if (visibleCount === total) {
            countElement.textContent = `${total} ingrédient(s)`;
        } else {
            countElement.textContent = `${visibleCount} ingrédient(s) affiché(s) sur ${total}`;
        }
    }
}

// Attacher les événements aux filtres
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchIngredients').addEventListener('keyup', filterIngredients);
    document.getElementById('filterCategorie').addEventListener('change', filterIngredients);
    document.getElementById('filterRangement').addEventListener('change', filterIngredients);
    document.getElementById('filterSaison').addEventListener('change', filterIngredients);
});
</script>
{% endblock %}
