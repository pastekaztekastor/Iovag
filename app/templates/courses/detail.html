{% extends "base.html" %}

{% block title %}{{ liste.nom }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('courses.index') }}">Listes de courses</a></li>
                <li class="breadcrumb-item active">{{ liste.nom }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h1 class="card-title">
                    <i class="bi bi-cart"></i> {{ liste.nom }}
                    {% if liste.statut == 'brouillon' %}
                    <span class="badge bg-secondary">Brouillon</span>
                    {% elif liste.statut == 'validee' %}
                    <span class="badge bg-primary">Validée</span>
                    {% elif liste.statut == 'en_course' %}
                    <span class="badge bg-warning text-dark">En cours</span>
                    {% elif liste.statut == 'terminee' %}
                    <span class="badge bg-success">Terminée</span>
                    {% endif %}
                </h1>

                {% if liste.menu %}
                <p class="text-muted">
                    <i class="bi bi-calendar-week"></i> Généré depuis le menu :
                    <a href="{{ url_for('menus.detail', id=liste.menu.id) }}">{{ liste.menu.nom }}</a>
                </p>
                {% endif %}

                <!-- Progression -->
                {% set nb_ingredients = liste.ingredients.count() %}
                {% set nb_achetes = liste.ingredients.filter_by(achete=True).count() %}

                <div class="alert {% if nb_achetes == nb_ingredients %}alert-success{% else %}alert-info{% endif %}">
                    <strong>Progression :</strong> {{ nb_achetes }}/{{ nb_ingredients }} article(s) acheté(s)
                    <div class="progress mt-2" style="height: 25px;">
                        <div class="progress-bar {% if nb_achetes == nb_ingredients %}bg-success{% endif %}"
                             role="progressbar"
                             style="width: {{ (nb_achetes / nb_ingredients * 100)|round if nb_ingredients > 0 else 0 }}%">
                            {{ (nb_achetes / nb_ingredients * 100)|round if nb_ingredients > 0 else 0 }}%
                        </div>
                    </div>
                </div>

                <!-- Phase BROUILLON : Explication du workflow -->
                {% if liste.statut == 'brouillon' %}
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Phase de brouillon</h6>
                    <p class="mb-0">Cliquez sur "Réviser la liste" pour vérifier automatiquement votre stock et retirer les articles dont vous n'avez pas besoin.</p>
                </div>
                {% endif %}

                <!-- Phase VALIDEE : Explication -->
                {% if liste.statut == 'validee' %}
                <div class="alert alert-primary">
                    <h6><i class="bi bi-eye"></i> Phase de vérification physique</h6>
                    <p class="mb-0">Vérifiez physiquement votre stock à la maison. Décochez les articles que vous possédez déjà. Une fois prêt, commencez les courses pour aller au magasin.</p>
                </div>
                {% endif %}

                <!-- Phase EN_COURSE : Explication -->
                {% if liste.statut == 'en_course' %}
                <div class="alert alert-warning">
                    <h6><i class="bi bi-cart-fill"></i> En cours de courses</h6>
                    <p class="mb-0">Les quantités affichées sont arrondies à l'unité supérieure. Cochez les articles achetés et ajustez les quantités si nécessaire.</p>
                </div>
                {% endif %}

                <!-- Liste des ingrédients -->
                <h2 class="mt-4 mb-3"><i class="bi bi-basket"></i> Articles</h2>

                {% if liste.ingredients.count() > 0 %}

                {% if liste.statut == 'en_course' %}
                <!-- Phase EN_COURSE : Grouper par rayon -->
                {% set items = liste.ingredients.all() %}
                {% set items_par_rayon = {} %}
                {% for item in items %}
                    {% set rayon_nom = item.rayon if item.rayon else 'Autre' %}
                    {% if rayon_nom not in items_par_rayon %}
                        {% set _ = items_par_rayon.update({rayon_nom: []}) %}
                    {% endif %}
                    {% set _ = items_par_rayon[rayon_nom].append(item) %}
                {% endfor %}

                {% for rayon, items_rayon in items_par_rayon.items() %}
                <div class="mb-4">
                    <h5 class="text-warning">
                        <i class="bi bi-shop"></i> {{ rayon }} ({{ items_rayon|length }})
                    </h5>
                    <form id="updateForm_{{ loop.index }}">
                        <ul class="list-group">
                            {% for item in items_rayon %}
                            <li class="list-group-item">
                              <div class="row align-items-center">
                                    <!-- Checkbox -->
                                    <div class="col-auto">
                                        <div class="form-check">
                                            <input class="form-check-input ingredient-checkbox"
                                                   type="checkbox"
                                                   value="{{ item.id }}"
                                                   id="ingredient_{{ item.id }}"
                                                   {% if item.achete %}checked{% endif %}
                                                   onchange="toggleIngredient({{ item.id }}, this.checked)">
                                        </div>
                                    </div>

                                    <!-- Nom et quantités -->
                                    <div class="col">
                                        <label class="form-check-label w-100 {% if item.achete %}text-decoration-line-through text-muted{% endif %}"
                                               for="ingredient_{{ item.id }}"
                                               id="label_{{ item.id }}">

                                            <!-- Nom de l'ingrédient -->
                                            <strong>{{ item.nom_ingredient }}</strong>
                                            <br>

                                            <!-- Quantité arrondie -->
                                            <small class="text-muted">
                                                À acheter : <strong class="text-primary">{{ item.get_affichage_quantite() }}</strong>
                                            </small>

                                            <!-- Quantité achetée éditable -->
                                            <br>
                                            <div class="input-group input-group-sm mt-2" style="max-width: 300px;">
                                                <span class="input-group-text">Achetée :</span>
                                                <input type="number"
                                                       class="form-control"
                                                       id="qte_{{ item.id }}"
                                                       value="{{ item.quantite_achetee if item.quantite_achetee is not none else item.quantite }}"
                                                       step="0.1"
                                                       min="0"
                                                       onchange="updateQuantite({{ item.id }}, this.value)">
                                                <span class="input-group-text">{{ item.unite }}</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </form>
                </div>
                {% endfor %}

                {% else %}
                <!-- Autres phases : Liste simple sans groupement -->
                <form id="updateForm">
                    <ul class="list-group">
                        {% for item in liste.ingredients.all() %}
                        <li class="list-group-item">
                          <div class="row align-items-center">
                                <!-- Checkbox (uniquement si terminee pour affichage) -->
                                {% if liste.statut == 'terminee' and item.achete %}
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input class="form-check-input ingredient-checkbox"
                                               type="checkbox"
                                               value="{{ item.id }}"
                                               id="ingredient_{{ item.id }}"
                                               {% if item.achete %}checked{% endif %}
                                               onchange="toggleIngredient({{ item.id }}, this.checked)">
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Nom et quantités -->
                                <div class="col">
                                    <label class="form-check-label w-100 {% if item.achete %}text-decoration-line-through text-muted{% endif %}"
                                           for="ingredient_{{ item.id }}"
                                           id="label_{{ item.id }}">

                                        <!-- Nom de l'ingrédient -->
                                        <strong>{{ item.nom_ingredient }}</strong>

                                        <!-- Rayon -->
                                        {% if item.rayon %}
                                        <span class="badge bg-secondary ms-2">{{ item.rayon }}</span>
                                        {% endif %}

                                        <br>

                                        <!-- Quantité nécessaire (toujours affichée) -->

                                        <small class="text-muted">
                                            Nécessaire : {{ item.get_affichage_quantite() }}
                                        </small>

                                        <!-- Phase TERMINEE : Afficher quantité achetée -->
                                        {% if liste.statut == 'terminee' and item.quantite_achetee is not none %}
                                        <br>
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i> Acheté : {{ item.quantite_achetee }} {{ item.unite }}
                                        </small>
                                        {% endif %}

                                    </label>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </form>
                {% endif %}

                {% else %}
                <p class="text-muted">Aucun ingrédient dans cette liste</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Actions</h5>
                <div class="d-grid gap-2">
                    {% if liste.statut == 'brouillon' %}
                    <a href="{{ url_for('courses.reviser', id=liste.id) }}" class="btn btn-primary w-100">
                        <i class="bi bi-clipboard-check"></i> Réviser la liste
                    </a>
                    <small class="text-muted">Vérifiez votre stock avant de valider</small>

                    {% elif liste.statut == 'validee' %}
                    <a href="{{ url_for('courses.verifier', id=liste.id) }}" class="btn btn-primary w-100">
                        <i class="bi bi-eye"></i> Vérifier physiquement
                    </a>
                    <small class="text-muted">Vérifiez votre stock à la maison</small>

                    {% elif liste.statut == 'en_course' %}
                    <form method="POST" action="{{ url_for('courses.confirmer', id=liste.id) }}">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-check2-all"></i> Terminer les courses
                        </button>
                    </form>
                    <small class="text-muted">Confirmez pour mettre à jour le stock</small>

                    {% elif liste.statut == 'terminee' %}
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle-fill"></i> Courses terminées<br>
                        <small>Le stock a été mis à jour</small>
                    </div>
                    {% endif %}

                    <hr>

                    <a href="{{ url_for('courses.export_pdf', id=liste.id) }}" class="btn btn-outline-success">
                        <i class="bi bi-file-pdf"></i> Exporter en PDF
                    </a>
                    {% if liste.menu %}
                    <a href="{{ url_for('menus.detail', id=liste.menu.id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-calendar-week"></i> Voir le menu
                    </a>
                    {% endif %}

                    {% if liste.statut != 'terminee' %}
                    <form method="POST" action="{{ url_for('courses.delete', id=liste.id) }}" onsubmit="return confirmDelete('Êtes-vous sûr de vouloir supprimer cette liste ?');">
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="bi bi-trash"></i> Supprimer
                        </button>
                    </form>
                    {% endif %}

                    <hr>
                    <a href="{{ url_for('courses.index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Retour aux listes
                    </a>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-info-circle"></i> Informations</h5>
                <p class="card-text">
                    <small class="text-muted">
                        Créée le {{ liste.created_at.strftime('%d/%m/%Y à %H:%M') }}
                    </small>
                </p>

                <!-- Workflow expliqué -->
                <h6 class="mt-3">Workflow :</h6>
                <ol class="small">
                    <li class="{% if liste.statut == 'brouillon' %}text-primary fw-bold{% elif liste.statut in ['validee', 'en_course', 'terminee'] %}text-success{% endif %}">
                        <i class="bi bi-clipboard-check"></i> Révision (stock app)
                    </li>
                    <li class="{% if liste.statut == 'validee' %}text-primary fw-bold{% elif liste.statut in ['en_course', 'terminee'] %}text-success{% endif %}">
                        <i class="bi bi-eye"></i> Vérification physique
                    </li>
                    <li class="{% if liste.statut == 'en_course' %}text-warning fw-bold{% elif liste.statut == 'terminee' %}text-success{% endif %}">
                        <i class="bi bi-cart"></i> Courses au magasin
                    </li>
                    <li class="{% if liste.statut == 'terminee' %}text-success fw-bold{% endif %}">
                        <i class="bi bi-check2-all"></i> Finalisation
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleIngredient(itemId, checked) {
    // Update UI immediately
    const label = document.getElementById('label_' + itemId);
    if (checked) {
        label.classList.add('text-decoration-line-through', 'text-muted');
    } else {
        label.classList.remove('text-decoration-line-through', 'text-muted');
    }

    // Send update to server
    fetch('{{ url_for("courses.toggle_ingredient", id=liste.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            item_id: itemId,
            achete: checked
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update progress bar
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Revert UI on error
        document.getElementById('ingredient_' + itemId).checked = !checked;
        if (!checked) {
            label.classList.add('text-decoration-line-through', 'text-muted');
        } else {
            label.classList.remove('text-decoration-line-through', 'text-muted');
        }
    });
}

function updateQuantite(itemId, quantite) {
    fetch('{{ url_for("courses.update_quantite", id=liste.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            item_id: itemId,
            quantite_achetee: quantite
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Visual feedback
            const input = document.getElementById('qte_' + itemId);
            input.classList.add('border-success');
            setTimeout(() => {
                input.classList.remove('border-success');
            }, 1000);
        } else {
            alert('Erreur lors de la mise à jour de la quantité');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la mise à jour de la quantité');
    });
}
</script>
{% endblock %}
