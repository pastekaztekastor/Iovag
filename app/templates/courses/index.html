{% extends "base.html" %}

{% block title %}Mes Listes de Courses{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/contextual-onboarding.css') }}">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-5">
            <i class="bi bi-cart"></i> Mes Listes de Courses
        </h1>
        <p class="lead text-muted">{{ listes|length }} liste(s)</p>
    </div>
</div>

<!-- Filtres -->
<div class="row mb-4">
    <div class="col-md-6">
        <input type="text" class="form-control" id="searchListes" placeholder="Rechercher une liste...">
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterStatus">
            <option value="">Toutes les listes</option>
            <option value="incomplete">Non terminÃ©es</option>
            <option value="complete">TerminÃ©es</option>
        </select>
    </div>
</div>

<!-- Liste des listes de courses -->
{% if listes %}
<div class="row">
    {% for liste in listes %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    {{ liste.nom }}
                    {% if liste.statut == 'brouillon' %}
                    <span class="badge bg-secondary">Brouillon</span>
                    {% elif liste.statut == 'validee' %}
                    <span class="badge bg-primary">ValidÃ©e</span>
                    {% elif liste.statut == 'en_course' %}
                    <span class="badge bg-warning text-dark">En cours</span>
                    {% elif liste.statut == 'terminee' %}
                    <span class="badge bg-success">TerminÃ©e</span>
                    {% endif %}
                </h5>

                <p class="card-text text-muted">
                    <i class="bi bi-calendar3"></i> {{ liste.created_at.strftime('%d/%m/%Y') }}<br>
                    {% if liste.menu %}
                    <i class="bi bi-calendar-week"></i> <a href="{{ url_for('menus.detail', id=liste.menu.id) }}">{{ liste.menu.nom }}</a><br>
                    {% endif %}
                </p>

                {% set nb_ingredients = liste.ingredients.count() %}
                {% set nb_achetes = liste.ingredients.filter_by(achete=True).count() %}

                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar {% if nb_achetes == nb_ingredients %}bg-success{% endif %}"
                         role="progressbar"
                         style="width: {{ (nb_achetes / nb_ingredients * 100)|round if nb_ingredients > 0 else 0 }}%"
                         aria-valuenow="{{ nb_achetes }}"
                         aria-valuemin="0"
                         aria-valuemax="{{ nb_ingredients }}">
                        {{ nb_achetes }}/{{ nb_ingredients }}
                    </div>
                </div>

                <p class="card-text">
                    <small class="text-muted">
                        <i class="bi bi-basket"></i> {{ nb_ingredients }} article(s)
                    </small>
                </p>
            </div>

            <div class="card-footer bg-white">
                <a href="{{ url_for('courses.detail', id=liste.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i> Voir
                </a>
                <a href="{{ url_for('courses.export_pdf', id=liste.id) }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-file-pdf"></i> PDF
                </a>
                <form method="POST" action="{{ url_for('courses.delete', id=liste.id) }}" class="d-inline" onsubmit="return confirmDelete('ÃŠtes-vous sÃ»r de vouloir supprimer cette liste ?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> Vous n'avez pas encore crÃ©Ã© de liste de courses.
    <a href="{{ url_for('menus.index') }}" class="alert-link">CrÃ©er un menu pour gÃ©nÃ©rer une liste</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/contextual-onboarding.js') }}"></script>
<script>
// Onboarding contextuel
{% if not current_user.onboarding_courses %}
const coursesSteps = [
    {
        target: 'h1',
        title: 'Bienvenue dans vos listes de courses !',
        content: 'GÃ©rez toutes vos listes de courses ici. Elles peuvent Ãªtre gÃ©nÃ©rÃ©es automatiquement depuis vos menus ou crÃ©Ã©es manuellement.',
        icon: 'ğŸ›’',
        position: 'bottom'
    },
    {
        target: '#searchListes',
        title: 'Rechercher une liste',
        content: 'Retrouvez rapidement une liste de courses par son nom.',
        icon: 'ğŸ”',
        position: 'bottom'
    },
    {
        target: '#filterStatus',
        title: 'Filtrer par statut',
        content: 'Filtrez vos listes selon leur avancement : brouillon, validÃ©e, en cours ou terminÃ©e.',
        icon: 'ğŸ“Š',
        position: 'bottom'
    },
    {
        target: '.progress',
        title: 'Suivez votre progression',
        content: 'Cette barre de progression montre combien d\'articles vous avez dÃ©jÃ  achetÃ©s. Pratique pour faire vos courses !',
        icon: 'âœ…',
        position: 'top'
    },
    {
        target: '.btn-outline-secondary',
        title: 'Exporter en PDF',
        content: 'TÃ©lÃ©chargez votre liste au format PDF pour l\'imprimer ou la consulter hors ligne pendant vos courses.',
        icon: 'ğŸ“„',
        position: 'top'
    }
];

initOnboarding('courses', true, coursesSteps);
{% endif %}
</script>
{% endblock %}
